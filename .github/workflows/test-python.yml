name: Test Python Demos

on:
  push:
    branches: [main, gilfree]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/test-python.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.py'
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.13', '3.14']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Check Python version and GIL status
        run: |
          uv run python --version
          uv run python -VV
          uv run python -c "import sys; print('Python version:', sys.version); print('GIL available:', hasattr(sys, '_is_gil_enabled'))"

      - name: Lint with ruff (if available)
        run: |
          uv run python -m pip list | grep ruff || echo "Ruff not installed, skipping"
        continue-on-error: true

      - name: Test imports
        run: |
          uv run python -c "import aiohttp; print('✓ aiohttp')"
          uv run python -c "import bs4; print('✓ beautifulsoup4')"
          uv run python -c "from rich.console import Console; print('✓ rich')"
          uv run python -c "from fastapi import FastAPI; print('✓ fastapi')"
          uv run python -c "import plotext; print('✓ plotext')"

      - name: Validate scraper.py syntax
        run: uv run python -m py_compile scraper.py

      - name: Validate demos syntax
        run: |
          uv run python -m py_compile demos/terminal_demo.py
          uv run python -m py_compile demos/test_server.py

      - name: Validate lessons syntax
        run: |
          uv run python -m py_compile lessons/__init__.py
          uv run python -m py_compile lessons/utils.py

      - name: Test FastAPI server startup (smoke test)
        run: |
          timeout 10s uv run uvicorn demos.test_server:app --host 127.0.0.1 --port 8000 &
          sleep 5
          curl -f http://127.0.0.1:8000 || echo "Server test complete"
        continue-on-error: true

      - name: Display summary
        run: |
          echo "✅ All Python files validated successfully"
          echo "✅ All dependencies imported correctly"
          echo "Python ${{ matrix.python-version }} tests complete!"
